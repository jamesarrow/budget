<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MY BUDGET — Vision Glass v2.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#f7f9ff;--bg2:#ffffff;--text:#111827;--muted:#6b7280;--glass:rgba(255,255,255,.6);--glass-brd:rgba(17,24,39,.06);--ring:rgba(17,24,39,.12);
    }
    @media (prefers-color-scheme: dark){
      :root{--bg1:#0c101a;--bg2:#0f172a;--text:#e5e7eb;--muted:#a3a3a3;--glass:rgba(17,24,39,.55);--glass-brd:rgba(255,255,255,.08);--ring:rgba(255,255,255,.12)}
    }
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh}
    .glass{backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);background:var(--glass);border:1px solid var(--glass-brd);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn{padding:.6rem 1rem;border-radius:12px;font-weight:600;background:rgba(255,255,255,.7);border:1px solid var(--glass-brd);transition:all .25s cubic-bezier(.4,0,.2,1)}
    .btn:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(0,0,0,.08)}
    .btn-primary{background:#111827;color:#fff}
    .btn-primary:hover{filter:brightness(.95)}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-danger:hover{filter:brightness(.95)}
    .hover-card{transition:all .25s cubic-bezier(.4,0,.2,1)}
    .hover-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 12px 28px rgba(0,0,0,.08)}
    .input{background:rgba(255,255,255,.8);border:1px solid var(--glass-brd);border-radius:12px;padding:.6rem .8rem;outline:none}
    .input:focus{box-shadow:0 0 0 4px var(--ring)}
    .logo{letter-spacing:.18em;font-weight:600}
    .sidebar{position:sticky;top:18px;height:calc(100vh - 36px)}
    dialog{border:none;border-radius:18px;padding:0}
    dialog::backdrop{background:rgba(0,0,0,.35);backdrop-filter:blur(6px)}
    @keyframes fade{from{opacity:0;transform:translateY(8px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .appear{animation:fade .35s ease both}
    .chip{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:#111827;color:#fff;font-size:.72rem;font-weight:600}
    .kbd{padding:.15rem .4rem;border-radius:6px;border:1px solid var(--glass-brd);background:rgba(255,255,255,.7);font-size:.72rem}
    .cat-pill{border:1px solid var(--glass-brd);border-radius:12px;padding:.55rem .8rem;cursor:pointer;user-select:none;transition:all .25s cubic-bezier(.4,0,.2,1)}
    .cat-pill:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(0,0,0,.08)}
    .cat-pill.active{background:#111827;color:#fff;box-shadow:0 12px 28px rgba(0,0,0,.14)}
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="grid grid-cols-12 gap-6">
      <!-- Sidebar -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <div class="glass sidebar p-4 appear">
          <div class="text-sm text-[color:var(--muted)] mb-1">Dashboard</div>
          <div class="text-2xl logo mb-4">MY BUDGET</div>
          <div class="space-y-2">
            <button id="addBtn" class="btn w-full">Добавить запись <span class="ml-2 kbd">N</span></button>
            <button id="addCategoryBtn" class="btn w-full">Категории</button>
            <button id="limitsBtn" class="btn w-full">Лимиты</button>
            <button id="exportBtn" class="btn w-full">Экспорт CSV</button>
            <button id="resetBtn" class="btn btn-danger w-full">Очистить</button>
          </div>
          <div class="mt-6 text-xs text-[color:var(--muted)]">Данные сохраняются только на этом устройстве (localStorage).</div>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-span-12 md:col-span-9 lg:col-span-10 space-y-6">
        <!-- Summary -->
        <section class="grid sm:grid-cols-3 gap-4">
          <div class="glass p-5 appear hover-card">
            <div class="text-sm text-[color:var(--muted)]">Получено</div>
            <div id="incomeSum" class="text-3xl font-semibold mt-1">—</div>
          </div>
          <div class="glass p-5 appear hover-card" style="animation-delay:.05s">
            <div class="text-sm text-[color:var(--muted)]">Потрачено</div>
            <div id="expenseSum" class="text-3xl font-semibold mt-1">—</div>
          </div>
          <div class="glass p-5 appear hover-card" style="animation-delay:.1s">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-[color:var(--muted)]">Баланс месяца</div>
                <div id="balance" class="text-3xl font-semibold mt-1">—</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-[color:var(--muted)]">Потрачено от дохода</div>
                <div id="spentPct" class="text-xl font-semibold mt-1">—</div>
              </div>
            </div>
            <div class="mt-4 w-full bg-white/60 rounded-full h-2 overflow-hidden">
              <div id="progressBar" class="h-2 rounded-full" style="background:#111827;width:0%"></div>
            </div>
          </div>
        </section>

        <!-- Charts & Heatmap -->
        <section class="grid lg:grid-cols-3 gap-4">
          <div class="glass p-5 appear hover-card lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h2 class="font-semibold">Расходы по категориям</h2>
              <div class="text-sm text-[color:var(--muted)]">Месяц: <span id="monthLabel"></span></div>
            </div>
            <canvas id="pieChart" height="140"></canvas>
          </div>
          <div class="glass p-5 appear hover-card">
            <h2 class="font-semibold mb-2">Динамика по дням</h2>
            <canvas id="barChart" height="140"></canvas>
          </div>
        </section>

        <section class="grid lg:grid-cols-3 gap-4">
          <div class="glass p-5 appear hover-card lg:col-span-1">
            <h2 class="font-semibold mb-2">Календарь расходов</h2>
            <div id="calendar" class="grid grid-cols-7 gap-1 text-sm"></div>
          </div>
          <div class="glass p-5 appear hover-card lg:col-span-2">
            <h2 class="font-semibold mb-2">Инсайты</h2>
            <div id="insights" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
          </div>
        </section>

        <!-- Category cards -->
        <section class="space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">Расходы по категориям</h2>
          </div>
          <div id="categoriesGrid" class="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </section>

        <!-- Table -->
        <section class="glass p-5 appear hover-card">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Записи текущего месяца</h2>
            <div class="text-sm text-[color:var(--muted)]">Сортировка: <span id="sortInfo">дата ↑</span></div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm" id="table">
              <thead>
                <tr class="text-left text-[color:var(--muted)] border-b">
                  <th class="py-2 cursor-pointer" data-sort="date">Дата</th>
                  <th class="py-2 cursor-pointer" data-sort="type">Тип</th>
                  <th class="py-2 cursor-pointer" data-sort="category">Категория</th>
                  <th class="py-2 cursor-pointer" data-sort="amount">Сумма</th>
                  <th class="py-2">Примечание</th>
                  <th class="py-2 text-right">Действия</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div id="undoWrap" class="mt-3 hidden">
            <button id="undoBtn" class="btn">Отменить удаление</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal: Add Category -->
  <dialog id="modalCategory">
    <form method="dialog" class="glass p-6 w-[92vw] max-w-md appear">
      <h3 class="text-xl font-semibold mb-4">Категории</h3>
      <div class="flex gap-2 mb-3">
        <input id="newCategoryName" class="input flex-1" placeholder="Новая категория"/>
        <button id="saveCatBtn" class="btn">Добавить</button>
      </div>
      <div class="text-sm text-[color:var(--muted)] mb-2">Текущие:</div>
      <div id="catList" class="flex flex-wrap gap-2"></div>
      <div class="flex justify-end mt-5">
        <button id="closeCatModal" class="btn" value="cancel">Закрыть</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Limits -->
  <dialog id="modalLimits">
    <form method="dialog" class="glass p-6 w-[92vw] max-w-lg appear">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold">Лимиты по категориям</h3>
        <button type="button" id="closeLimits" class="btn">Закрыть</button>
      </div>
      <div id="limitsBody" class="grid sm:grid-cols-2 gap-3"></div>
      <div class="flex justify-end gap-3 mt-5">
        <button class="btn btn-primary">Сохранить</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Add Entry -->
  <dialog id="modal">
    <form id="form" method="dialog" class="glass p-6 w-[92vw] max-w-lg appear">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold">Добавить запись</h3>
        <button type="button" id="closeModal" class="btn">Закрыть</button>
      </div>
      <div class="grid gap-4">
        <div class="flex items-center gap-6">
          <label class="flex items-center gap-2"><input type="radio" name="type" value="income" class="accent-black" checked /> Доход</label>
          <label class="flex items-center gap-2"><input type="radio" name="type" value="expense" class="accent-black" /> Расход</label>
        </div>
        <input id="date" type="date" class="input" />
        <!-- Category cards selector -->
        <div>
          <div class="text-sm text-[color:var(--muted)] mb-2">Категория (нажми, чтобы выбрать)</div>
          <div id="categoryCardsPicker" class="flex gap-2 overflow-x-auto pb-2"></div>
        </div>
        <input id="amount" type="number" min="0" step="1000" placeholder="Сумма (VND)" class="input" />
        <input id="note" type="text" placeholder="Примечание" class="input" />
      </div>
      <div class="flex justify-end gap-3 mt-5">
        <button class="btn btn-primary" id="saveBtn">Сохранить</button>
      </div>
    </form>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utils
      const fmt = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'VND', maximumFractionDigits:0 });
      const monthKey = (iso) => iso.slice(0,7);
      const todayISO = () => new Date().toISOString().slice(0,10);
      const daysInMonth = (y,m)=> new Date(y,m,0).getDate();

      // ===== Storage keys
      const STORAGE_KEY = 'mybudget_entries_v5';
      const CAT_KEY = 'mybudget_categories_v5';
      const LIM_KEY = 'mybudget_limits_v2';

      // ===== State
      let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let categories = JSON.parse(localStorage.getItem(CAT_KEY) || '[]');
      let limits = JSON.parse(localStorage.getItem(LIM_KEY) || '{}');
      let lastDeleted = null;
      let sortState = { key:'date', dir:'asc' };
      let selectedCategory = '';

      if (!Array.isArray(categories) || categories.length === 0) {
        categories = ['доход','еда','кофе','алкоголь','одежда','транспорт','коммуналка','развлечения','жильё','долги','прочее'];
        localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      }

      // ===== Elements
      const modal = document.getElementById('modal');
      const modalCategory = document.getElementById('modalCategory');
      const modalLimits = document.getElementById('modalLimits');
      const form = document.getElementById('form');
      const dateEl = document.getElementById('date');
      const amountEl = document.getElementById('amount');
      const noteEl = document.getElementById('note');
      const rowsEl = document.getElementById('rows');
      const monthLabel = document.getElementById('monthLabel');

      const addBtn = document.getElementById('addBtn');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      const exportBtn = document.getElementById('exportBtn');
      const resetBtn = document.getElementById('resetBtn');
      const limitsBtn = document.getElementById('limitsBtn');
      const closeModalBtn = document.getElementById('closeModal');
      const closeCatModalBtn = document.getElementById('closeCatModal');
      const saveCatBtn = document.getElementById('saveCatBtn');
      const newCategoryName = document.getElementById('newCategoryName');
      const closeLimitsBtn = document.getElementById('closeLimits');

      const incomeSum = document.getElementById('incomeSum');
      const expenseSum = document.getElementById('expenseSum');
      const balanceEl = document.getElementById('balance');
      const spentPct = document.getElementById('spentPct');
      const progressBar = document.getElementById('progressBar');

      const categoriesGrid = document.getElementById('categoriesGrid');
      const insightsBox = document.getElementById('insights');
      const calendarEl = document.getElementById('calendar');
      const sortInfo = document.getElementById('sortInfo');
      const undoWrap = document.getElementById('undoWrap');
      const undoBtn  = document.getElementById('undoBtn');
      const categoryCardsPicker = document.getElementById('categoryCardsPicker');
      const catList = document.getElementById('catList');

      let pie, bar;

      // ===== Helpers
      const save = ()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      const saveCats = ()=> localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      const saveLimits = ()=> localStorage.setItem(LIM_KEY, JSON.stringify(limits));

      function renderCategoryPicker(){
        categoryCardsPicker.innerHTML = '';
        const toShow = categories.filter(c=>c!=='доход');
        toShow.forEach((c,i)=>{
          const pill = document.createElement('div');
          pill.className = 'cat-pill appear';
          pill.style.animationDelay = (i*30)+'ms';
          pill.textContent = c;
          if(c===selectedCategory) pill.classList.add('active');
          pill.onclick = ()=>{ selectedCategory = c; renderCategoryPicker(); };
          categoryCardsPicker.appendChild(pill);
        });
      }

      function renderCatManager(){
        catList.innerHTML='';
        categories.forEach((c)=>{
          const el = document.createElement('div');
          el.className='cat-pill';
          el.textContent = c;
          catList.appendChild(el);
        });
      }

      // ===== Events: sidebar
      addBtn.addEventListener('click', () => { form.reset(); dateEl.value = todayISO(); selectedCategory = categories.find(c=>c!=='доход')||''; renderCategoryPicker(); if(!modal.open) modal.showModal(); });
      closeModalBtn.addEventListener('click', () => modal.close());

      addCategoryBtn.addEventListener('click', () => { newCategoryName.value=''; renderCatManager(); if(!modalCategory.open) modalCategory.showModal(); });
      closeCatModalBtn.addEventListener('click', () => modalCategory.close());
      saveCatBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (newCategoryName.value||'').trim();
        if(!name) return alert('Введите название категории');
        if(categories.includes(name)) return alert('Такая категория уже есть');
        categories.push(name); saveCats(); renderCatManager(); alert(`Категория «${name}» добавлена`);
      });

      limitsBtn.addEventListener('click', () => { buildLimitsUI(); if(!modalLimits.open) modalLimits.showModal(); });
      closeLimitsBtn.addEventListener('click', ()=> modalLimits.close());

      exportBtn.addEventListener('click', () => {
        const header = ['id','type','date','category','amount','note'];
        const csv = [header.join(',')].concat(entries.map(e=> header.map(k=>""+String(e[k]??'').replaceAll('"','""')).map(v=>`"${v}`+`"`).join(','))).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`mybudget_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
      });

      resetBtn.addEventListener('click', () => {
        if(confirm('Точно удалить все данные?')){ entries = []; save(); refresh(); }
      });

      // Add entry
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const type = form.elements['type'].value; // income | expense
        const date = dateEl.value || todayISO();
        const amount = Number(amountEl.value||0);
        const note = (noteEl.value||'').trim();
        if(!amount || amount<=0) return alert('Укажи сумму');
        const category = type==='income' ? 'доход' : selectedCategory || 'прочее';
        entries.push({ id: crypto.randomUUID(), type, date, category, amount, note });
        save(); modal.close(); refresh();
      });

      // Table interactions
      document.getElementById('table').addEventListener('click', (ev)=>{
        const delBtn = ev.target.closest('[data-del]');
        const head = ev.target.closest('th[data-sort]');
        if(delBtn){ const id = delBtn.getAttribute('data-del'); const rec = entries.find(x=>x.id===id); lastDeleted = rec||null; entries = entries.filter(x=> x.id !== id); save(); refresh(); showUndo(); return; }
        if(head){ const key = head.getAttribute('data-sort'); toggleSort(key); refresh(); }
      });
      undoBtn.addEventListener('click', ()=>{ if(lastDeleted){ entries.push(lastDeleted); save(); lastDeleted=null; refresh(); hideUndo(); } });

      // ===== Renders core
      function toggleSort(key){ if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); } else { sortState.key=key; sortState.dir='asc'; } sortInfo.textContent = `${key} ${sortState.dir==='asc'?'↑':'↓'}`; }
      function showUndo(){ undoWrap.classList.remove('hidden'); }
      function hideUndo(){ undoWrap.classList.add('hidden'); }

      function renderCharts(monthEntries){
        const byCat = {}; const byDay = {};
        monthEntries.filter(e=> e.type==='expense' && e.category!=='долги').forEach(e=>{ byCat[e.category]=(byCat[e.category]||0)+e.amount; byDay[e.date]=(byDay[e.date]||0)+e.amount; });
        const pLabels = Object.keys(byCat), pData = Object.values(byCat);
        if(pie) pie.destroy();
        pie = new Chart(document.getElementById('pieChart'), { type:'doughnut', data:{ labels:pLabels, datasets:[{ data:pData, backgroundColor:['#111827','#6366F1','#06B6D4','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#84CC16','#14B8A6'] }] }, options:{ animation:{ duration:500 }, plugins:{ legend:{ position:'bottom' } }, cutout:'60%' } });
        const days = Array.from(new Set(monthEntries.map(e=>e.date))).sort();
        if(bar) bar.destroy();
        bar = new Chart(document.getElementById('barChart'), { type:'bar', data:{ labels:days, datasets:[{ data:days.map(d=>byDay[d]||0), backgroundColor:'#111827' }] }, options:{ animation:{ duration:500 }, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ maxRotation:0 } }, y:{ beginAtZero:true } } } });
      }

      function renderHeatmap(monthEntries){
        calendarEl.innerHTML='';
        const [y,m] = monthKey(todayISO()).split('-').map(Number);
        const dim = daysInMonth(y,m);
        const sums = {}; monthEntries.filter(e=>e.type==='expense' && e.category!=='долги').forEach(e=>{ const d=Number(e.date.split('-')[2]); sums[d]=(sums[d]||0)+e.amount; });
        const max = Math.max(1, ...Object.values(sums));
        for(let i=1;i<=dim;i++){
          const val = sums[i]||0; const alpha = Math.max(.1, val/max);
          const cell = document.createElement('div');
          cell.className='glass p-2 text-center appear hover-card';
          cell.innerHTML = `<div class='text-xs opacity-80'>${i}</div><div class='text-[10px] opacity-80'>${val?fmt.format(val):''}</div>`;
          cell.style.background = `rgba(17,24,39,${alpha})`;
          cell.style.color = '#fff';
          calendarEl.appendChild(cell);
        }
      }

      function renderCategoryCards(monthEntries){
        categoriesGrid.innerHTML='';
        const byCat = {}; monthEntries.filter(e=> e.type==='expense' && e.category!=='долги').forEach(e=> byCat[e.category]=(byCat[e.category]||0)+e.amount);
        const totalExp = Object.values(byCat).reduce((a,b)=>a+b,0);
        if(!totalExp){ categoriesGrid.innerHTML = `<div class='glass p-4 appear text-center text-[color:var(--muted)]'>Пока нет данных по расходам</div>`; return; }
        Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([cat,val],i)=>{
          const percent = Math.round(val/totalExp*100); const over = limits[cat] && val>Number(limits[cat]);
          const card = document.createElement('div');
          card.className='glass p-4 appear hover-card'; card.style.animationDelay=(i*35)+'ms';
          card.innerHTML = `
            <div class='flex justify-between items-center mb-2'>
              <div class='text-lg font-medium'>${cat}</div>
              <div class='text-sm text-[color:var(--muted)]'>${percent}%</div>
            </div>
            <div class='flex items-center justify-between mb-2'>
              <div class='text-2xl font-semibold'>${fmt.format(val)}</div>
              <div class='text-xs border rounded px-2 py-1 ${over?'bg-red-500/10 text-red-600 border-red-300/40':'border-[color:var(--glass-brd)]'}'>лимит: ${limits[cat]?fmt.format(Number(limits[cat])):'—'}</div>
            </div>
            <div class='w-full bg-white/60 rounded-full h-2 overflow-hidden'>
              <div class='h-2 rounded-full' style='background:#111827;width:${percent}%'></div>
            </div>`;
          categoriesGrid.appendChild(card);
        });
      }

      function buildInsights(monthEntries){
        insightsBox.innerHTML='';
        if(monthEntries.length===0){ insightsBox.innerHTML = `<div class='glass p-4 appear hover-card'>Пока нет данных</div>`; return; }
        const income = monthEntries.filter(e=>e.type==='income').reduce((a,b)=>a+b.amount,0);
        const expense = monthEntries.filter(e=>e.type==='expense' && e.category!=='долги').reduce((a,b)=>a+b.amount,0);
        const byCat = {}; monthEntries.filter(e=> e.type==='expense' && e.category!=='долги').forEach(e=> byCat[e.category]=(byCat[e.category]||0)+e.amount);
        const top = Object.entries(byCat).sort((a,b)=>b[1]-a[1])[0];
        const cards = [];
        const pct = income>0 ? (expense/income*100) : 0;
        if(income===0 && expense>0){ cards.push(['Добавь доходы','Чтобы увидеть баланс и проценты — внеси поступления.']); }
        else { cards.push(['Баланс и темп',`Сейчас израсходовано ${pct.toFixed(0)}% дохода.`]); }
        if(top){ const [tCat, tSum] = top; const cut = Math.round(tSum*0.25); cards.push([`Основная категория: ${tCat}`,`${fmt.format(tSum)} за месяц. Снижение на 25% даст ~${fmt.format(cut)} экономии.`]); }
        const today = new Date(); const daysGone = today.getDate(); const [y,m] = monthKey(todayISO()).split('-').map(Number); const dim = daysInMonth(y,m); const rate = expense / Math.max(1, daysGone); const forecast = Math.round(rate * dim);
        cards.push(['Прогноз',`Если продолжишь в том же темпе, расходы будут около ${fmt.format(forecast)} к концу месяца.`]);
        cards.forEach((c,i)=>{ const el=document.createElement('div'); el.className='glass p-4 appear hover-card'; el.style.animationDelay=(i*40)+'ms'; el.innerHTML=`<div class='font-semibold mb-1'>${c[0]}</div><div class='text-sm text-[color:var(--muted)]'>${c[1]}</div>`; insightsBox.appendChild(el); });
      }

      function renderTable(monthEntries){
        rowsEl.innerHTML = '';
        let data = monthEntries.slice();
        data.sort((a,b)=>{ const k = sortState.key, dir = sortState.dir==='asc'?1:-1; if(k==='amount') return dir*(a.amount-b.amount); return dir*String(a[k]).localeCompare(String(b[k])); });
        data.forEach((e,i)=>{
          const tr = document.createElement('tr'); tr.className='border-b border-[rgba(17,24,39,.08)] hover:bg-white/50 appear'; tr.style.animationDelay=(i*18)+'ms';
          tr.innerHTML = `
            <td class='py-2'>${e.date}</td>
            <td class='py-2'><span class='chip'>${e.type==='income'?'доход':'расход'}</span></td>
            <td class='py-2'>${e.category}</td>
            <td class='py-2 font-medium'>${fmt.format(e.amount)}</td>
            <td class='py-2'>${(e.note||'')}</td>
            <td class='py-2 text-right'><button class='btn' data-del='${e.id}'>Удалить</button></td>`;
          rowsEl.appendChild(tr);
        });
      }

      function buildLimitsUI(){
        const body = document.getElementById('limitsBody'); body.innerHTML='';
        categories.filter(c=>c!=='доход').forEach((c,i)=>{ const wrap=document.createElement('div'); wrap.className='glass p-3 appear'; wrap.style.animationDelay=(i*25)+'ms'; wrap.innerHTML=`<div class='text-sm mb-1'>${c}</div><input type='number' min='0' step='10000' class='input w-full' data-limit='${c}' placeholder='Лимит (VND)' value='${limits[c]||''}' />`; body.appendChild(wrap); });
        modalLimits.querySelector('form').onsubmit = (e)=>{ e.preventDefault(); body.querySelectorAll('[data-limit]').forEach(inp=>{ const key=inp.getAttribute('data-limit'); const v=Number(inp.value||0); if(v>0) limits[key]=v; else delete limits[key]; }); saveLimits(); modalLimits.close(); refresh(); };
      }

      function refresh(){
        document.getElementById('monthLabel').textContent = monthKey(todayISO());
        const m = monthKey(todayISO());
        const monthEntries = entries.filter(e=> monthKey(e.date)===m);
        const income = monthEntries.filter(e=>e.type==='income').reduce((a,b)=>a+b.amount,0);
        const expense = monthEntries.filter(e=>e.type==='expense' && e.category!=='долги').reduce((a,b)=>a+b.amount,0);
        incomeSum.textContent = income? fmt.format(income) : '—';
        expenseSum.textContent = expense? fmt.format(expense) : '—';
        balanceEl.textContent = fmt.format(income-expense);
        const pct = income>0 ? Math.min(100, Math.round(expense/income*100)) : 0; spentPct.textContent = income>0? pct+'%':'—'; progressBar.style.width = pct+'%';
        renderCharts(monthEntries); renderHeatmap(monthEntries); renderCategoryCards(monthEntries); buildInsights(monthEntries); renderTable(monthEntries); hideUndo();
      }

      // Sorting & table delete
      document.getElementById('table').addEventListener('click', (ev)=>{ const head = ev.target.closest('th[data-sort]'); const delBtn = ev.target.closest('[data-del]'); if(head){ const key=head.getAttribute('data-sort'); if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); } else { sortState.key=key; sortState.dir='asc'; } sortInfo.textContent = `${key} ${sortState.dir==='asc'?'↑':'↓'}`; refresh(); } if(delBtn){ const id=delBtn.getAttribute('data-del'); const rec=entries.find(x=>x.id===id); lastDeleted=rec||null; entries=entries.filter(x=>x.id!==id); save(); refresh(); undoWrap.classList.remove('hidden'); }});

      undoBtn.addEventListener('click', ()=>{ if(lastDeleted){ entries.push(lastDeleted); save(); lastDeleted=null; refresh(); undoWrap.classList.add('hidden'); }});

      // Init
      dateEl.value = todayISO();
      refresh();
    });
  </script>
</body>
</html>
