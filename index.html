<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyBudget VN ‚Äî v2.0 (Glass macOS)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-grad-1:#e8ecff;--bg-grad-2:#fff5ef;--text:#111827;--glass-bg:rgba(255,255,255,.42);--glass-brd:rgba(255,255,255,.55);--muted:#6b7280;--chip:#111827;--chip-ink:#fff;--bar:#111827;--line:#e5e7eb;--card:#ffffffaa
    }
    @media (prefers-color-scheme: dark){
      :root{--bg-grad-1:#0b1020;--bg-grad-2:#111827;--text:#e5e7eb;--glass-bg:rgba(17,24,39,.5);--glass-brd:rgba(255,255,255,.08);--muted:#9ca3af;--chip:#e5e7eb;--chip-ink:#111827;--bar:#e5e7eb;--line:#1f2937;--card:#111827aa}
    }
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg-grad-1) 0%,var(--bg-grad-2) 100%);min-height:100vh;color:var(--text)}
    .glass{backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);background:var(--glass-bg);border:1px solid var(--glass-brd);box-shadow:0 10px 30px rgba(0,0,0,.08);border-radius:20px}
    .btn{padding:.6rem 1.1rem;border-radius:12px;font-weight:600;transition:transform .15s ease,opacity .15s ease,background .2s ease;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#111827,#374151);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);background:linear-gradient(135deg,#0b0f1a,#1f2937)}
    .btn-ghost{background:rgba(255,255,255,.6);color:var(--text);border:1px solid rgba(0,0,0,.08)}
    .btn-ghost:hover{background:rgba(255,255,255,.82);transform:translateY(-1px)}
    .btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626;transform:translateY(-1px)}
    dialog{border:none;border-radius:20px;padding:0;overflow:visible}
    dialog::backdrop{background:rgba(0,0,0,.35);backdrop-filter:blur(6px)}
    @keyframes fadeScaleIn{from{opacity:0;transform:translateY(8px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .animate-card{animation:fadeScaleIn .38s ease both}
    .animate-soft{animation:fadeIn .28s ease both}
    .input{background:rgba(255,255,255,.8);border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:.6rem .8rem;outline:none}
    .input:focus{box-shadow:0 0 0 3px rgba(17,24,39,.12)}
    .sticky-nav{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, var(--card), transparent)}
    .chip{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:var(--chip);color:var(--chip-ink);font-size:.75rem;font-weight:600}
    .limit-badge{font-size:.7rem;padding:.15rem .45rem;border-radius:8px;border:1px solid var(--line)}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-6">
    <!-- Sticky Navbar -->
    <div class="sticky-nav backdrop-blur-md pb-3 mb-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h1 class="text-2xl md:text-3xl font-bold">üí∞ MyBudget VN <span class="text-[color:var(--muted)] text-base">v2.0</span></h1>
        <div class="flex flex-wrap gap-2">
          <button id="addBtn" class="btn btn-primary" title="–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥">Ôºã –ó–∞–ø–∏—Å—å</button>
          <button id="addCategoryBtn" class="btn btn-ghost" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">‚ûï –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
          <button id="limitsBtn" class="btn btn-ghost" title="–õ–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º">üéØ –õ–∏–º–∏—Ç—ã</button>
          <button id="exportBtn" class="btn btn-ghost" title="–≠–∫—Å–ø–æ—Ä—Ç CSV">‚¨áÔ∏è CSV</button>
          <button id="exportJsonBtn" class="btn btn-ghost" title="–≠–∫—Å–ø–æ—Ä—Ç JSON">üíæ JSON</button>
          <label class="btn btn-ghost cursor-pointer" title="–ò–º–ø–æ—Ä—Ç JSON">
            üìÇ –ò–º–ø–æ—Ä—Ç <input id="importJson" type="file" accept="application/json" class="hidden" />
          </label>
          <button id="resetBtn" class="btn btn-danger" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <section class="grid md:grid-cols-3 gap-5 mb-6">
      <div class="glass p-5 animate-card">
        <div class="text-sm text-[color:var(--muted)]">–ü–æ–ª—É—á–µ–Ω–æ</div>
        <div id="incomeSum" class="text-3xl font-semibold mt-1">‚Äî</div>
      </div>
      <div class="glass p-5 animate-card" style="animation-delay:.05s">
        <div class="text-sm text-[color:var(--muted)]">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
        <div id="expenseSum" class="text-3xl font-semibold mt-1">‚Äî</div>
      </div>
      <div class="glass p-5 animate-card" style="animation-delay:.1s">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-[color:var(--muted)]">–ë–∞–ª–∞–Ω—Å –º–µ—Å—è—Ü–∞</div>
            <div id="balance" class="text-3xl font-semibold mt-1">‚Äî</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-[color:var(--muted)]">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –æ—Ç –¥–æ—Ö–æ–¥–∞</div>
            <div id="spentPct" class="text-xl font-semibold mt-1">‚Äî</div>
          </div>
        </div>
        <div class="mt-4 w-full bg-white/60 rounded-full h-2 overflow-hidden">
          <div id="progressBar" class="h-2 rounded-full transition-all" style="background:var(--bar);width:0%"></div>
        </div>
      </div>
    </section>

    <!-- Charts + Heatmap -->
    <section class="grid lg:grid-cols-3 gap-5 mb-6">
      <div class="glass p-5 lg:col-span-2 animate-card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">üìä –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
          <div class="text-sm text-[color:var(--muted)]">–ú–µ—Å—è—Ü: <span id="monthLabel"></span></div>
        </div>
        <canvas id="pieChart" height="140"></canvas>
      </div>
      <div class="glass p-5 animate-card" style="animation-delay:.05s">
        <h2 class="font-semibold mb-2">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º</h2>
        <canvas id="barChart" height="140"></canvas>
      </div>
    </section>

    <section class="grid lg:grid-cols-3 gap-5 mb-6">
      <div class="glass p-5 animate-card lg:col-span-1">
        <h2 class="font-semibold mb-2">üóìÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞—Å—Ö–æ–¥–æ–≤ (heatmap)</h2>
        <div id="calendar" class="grid grid-cols-7 gap-1 text-sm"></div>
      </div>
      <div class="glass p-5 animate-card lg:col-span-2">
        <h2 class="font-semibold mb-2">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º –º–µ—Å—è—Ü–µ–º</h2>
        <div id="compare" class="grid sm:grid-cols-2 gap-3"></div>
      </div>
    </section>

    <!-- Category cards -->
    <section id="categoryCards" class="mb-6 animate-soft">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">üí∏ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
        <div class="text-sm flex gap-2 items-center">
          <label>–§–∏–ª—å—Ç—Ä: </label>
          <select id="filterCategory" class="input py-1"></select>
          <input id="dateFrom" type="date" class="input py-1"/>
          <input id="dateTo" type="date" class="input py-1"/>
          <button id="applyFilter" class="btn btn-ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div id="categoriesGrid" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </section>

    <!-- Insights -->
    <section class="glass p-5 mb-6 animate-card">
      <h2 class="font-semibold mb-2">üí¨ Smart‚Äë–∏–Ω—Å–∞–π—Ç—ã</h2>
      <div id="insights" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <!-- Table -->
    <section class="glass p-5 animate-card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">üìã –ó–∞–ø–∏—Å–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞</h2>
        <div class="text-sm text-[color:var(--muted)]">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: <span id="sortInfo">–¥–∞—Ç–∞ ‚Üë</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="table">
          <thead>
            <tr class="text-left text-[color:var(--muted)] border-b">
              <th class="py-2 cursor-pointer" data-sort="date">–î–∞—Ç–∞</th>
              <th class="py-2 cursor-pointer" data-sort="type">–¢–∏–ø</th>
              <th class="py-2 cursor-pointer" data-sort="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
              <th class="py-2 cursor-pointer" data-sort="amount">–°—É–º–º–∞</th>
              <th class="py-2">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
              <th class="py-2 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="undoWrap" class="mt-3 hidden">
        <button id="undoBtn" class="btn btn-ghost">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ</button>
      </div>
    </section>
  </div>

  <!-- Modal: Add Category -->
  <dialog id="modalCategory">
    <form method="dialog" class="glass p-6 w-[90vw] max-w-sm animate-card">
      <h3 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
      <input id="newCategoryName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" class="input w-full mb-4" />
      <div class="flex justify-end gap-3">
        <button id="closeCatModal" class="btn btn-ghost" value="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button id="saveCatBtn" class="btn btn-primary" value="default">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Limits -->
  <dialog id="modalLimits">
    <form method="dialog" class="glass p-6 w-[92vw] max-w-lg animate-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold">–õ–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
        <button type="button" id="closeLimits" class="btn btn-ghost">‚úï</button>
      </div>
      <div id="limitsBody" class="grid sm:grid-cols-2 gap-3"></div>
      <div class="flex justify-end gap-3 mt-5">
        <button class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Add Entry -->
  <dialog id="modal">
    <form id="form" method="dialog" class="glass p-6 w-[92vw] max-w-md animate-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <button type="button" id="closeModal" class="btn btn-ghost">‚úï</button>
      </div>
      <div class="grid gap-3">
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2"><input type="radio" name="type" value="income" class="accent-black" checked /> –î–æ—Ö–æ–¥</label>
          <label class="flex items-center gap-2"><input type="radio" name="type" value="expense" class="accent-black" /> –†–∞—Å—Ö–æ–¥</label>
        </div>
        <input id="date" type="date" class="input" />
        <select id="category" class="input"></select>
        <input id="amount" type="number" min="0" step="1000" placeholder="–°—É–º–º–∞ (VND)" class="input" />
        <input id="note" type="text" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" class="input" />
        <div class="text-sm text-[color:var(--muted)]">–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã:</div>
        <div class="flex flex-wrap gap-2">
          <button type="button" class="btn btn-ghost preset" data-cat="–∫–æ—Ñ–µ" data-amt="30000">‚òï –ö–æ—Ñ–µ</button>
          <button type="button" class="btn btn-ghost preset" data-cat="–∞–ª–∫–æ–≥–æ–ª—å" data-amt="350000">üç∫ –ê–ª–∫–æ–≥–æ–ª—å</button>
          <button type="button" class="btn btn-ghost preset" data-cat="–µ–¥–∞" data-amt="120000">üçö –ï–¥–∞</button>
          <button type="button" class="btn btn-ghost preset" data-cat="—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç" data-amt="25000">üõµ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-5">
        <button class="btn btn-primary" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utils
      const fmt = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'VND', maximumFractionDigits:0 });
      const monthKey = (iso) => iso.slice(0,7);
      const todayISO = () => new Date().toISOString().slice(0,10);
      const daysInMonth = (y,m)=> new Date(y,m,0).getDate();

      // ===== Storage keys
      const STORAGE_KEY = 'mybudget_entries_v4';
      const CAT_KEY = 'mybudget_categories_v4';
      const LIM_KEY = 'mybudget_limits_v1';

      // ===== State
      let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let categories = JSON.parse(localStorage.getItem(CAT_KEY) || '[]');
      let limits = JSON.parse(localStorage.getItem(LIM_KEY) || '{}');
      let lastDeleted = null;
      let sortState = { key:'date', dir:'asc' };
      let filterState = { cat:'', from:'', to:'' };

      if (!Array.isArray(categories) || categories.length === 0) {
        categories = ['–¥–æ—Ö–æ–¥','–µ–¥–∞','–∫–æ—Ñ–µ','–∞–ª–∫–æ–≥–æ–ª—å','–æ–¥–µ–∂–¥–∞','—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç','–∫–æ–º–º—É–Ω–∞–ª–∫–∞','—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è','–∂–∏–ª—å—ë','–¥–æ–ª–≥–∏','–ø—Ä–æ—á–µ–µ'];
        localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      }

      // ===== Elements
      const modal = document.getElementById('modal');
      const modalCategory = document.getElementById('modalCategory');
      const modalLimits = document.getElementById('modalLimits');
      const form = document.getElementById('form');
      const dateEl = document.getElementById('date');
      const catEl = document.getElementById('category');
      const amountEl = document.getElementById('amount');
      const noteEl = document.getElementById('note');
      const rowsEl = document.getElementById('rows');
      const monthLabel = document.getElementById('monthLabel');

      const addBtn = document.getElementById('addBtn');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      const exportBtn = document.getElementById('exportBtn');
      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const importJson = document.getElementById('importJson');
      const resetBtn = document.getElementById('resetBtn');
      const limitsBtn = document.getElementById('limitsBtn');
      const closeModalBtn = document.getElementById('closeModal');
      const closeCatModalBtn = document.getElementById('closeCatModal');
      const saveCatBtn = document.getElementById('saveCatBtn');
      const newCategoryName = document.getElementById('newCategoryName');
      const closeLimitsBtn = document.getElementById('closeLimits');

      const incomeSum = document.getElementById('incomeSum');
      const expenseSum = document.getElementById('expenseSum');
      const balanceEl = document.getElementById('balance');
      const spentPct = document.getElementById('spentPct');
      const progressBar = document.getElementById('progressBar');

      const filterCategory = document.getElementById('filterCategory');
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      const applyFilter = document.getElementById('applyFilter');
      const sortInfo = document.getElementById('sortInfo');

      const undoWrap = document.getElementById('undoWrap');
      const undoBtn  = document.getElementById('undoBtn');

      let pie, bar;

      // ===== Helpers
      const save = ()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      const saveCats = ()=> localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      const saveLimits = ()=> localStorage.setItem(LIM_KEY, JSON.stringify(limits));
      const populateCats = ()=> { catEl.innerHTML = categories.map(c=>`<option value="${c}">${c}</option>`).join(''); };
      const populateFilterCats = ()=> { filterCategory.innerHTML = `<option value="">–í—Å–µ</option>`+ categories.map(c=>`<option value="${c}">${c}</option>`).join(''); };

      const withinFilter = (e)=>{
        if(filterState.cat && e.category!==filterState.cat) return false;
        if(filterState.from && e.date < filterState.from) return false;
        if(filterState.to && e.date > filterState.to) return false;
        return true;
      };

      // ===== Events: navbar
      addBtn.addEventListener('click', () => { populateCats(); form.reset(); dateEl.value = todayISO(); if(!modal.open) modal.showModal(); });
      closeModalBtn.addEventListener('click', () => modal.close());

      addCategoryBtn.addEventListener('click', () => { newCategoryName.value=''; if(!modalCategory.open) modalCategory.showModal(); });
      closeCatModalBtn.addEventListener('click', () => modalCategory.close());
      saveCatBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (newCategoryName.value||'').trim();
        if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        if(categories.includes(name)) return alert('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å');
        categories.push(name); saveCats(); modalCategory.close(); populateCats(); populateFilterCats();
        setTimeout(()=> alert(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ¬´${name}¬ª –¥–æ–±–∞–≤–ª–µ–Ω–∞`), 50);
      });

      limitsBtn.addEventListener('click', () => { buildLimitsUI(); if(!modalLimits.open) modalLimits.showModal(); });
      closeLimitsBtn.addEventListener('click', ()=> modalLimits.close());

      exportBtn.addEventListener('click', () => {
        const header = ['id','type','date','category','amount','note'];
        const csv = [header.join(',')].concat(entries.map(e=> header.map(k=>""+String(e[k]??'').replaceAll('"','""')).map(v=>`"${v}`+`"`).join(','))).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`mybudget_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
      });

      exportJsonBtn.addEventListener('click', ()=>{
        const data = { entries, categories, limits };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`mybudget_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
      });

      importJson.addEventListener('change', (ev)=>{
        const file = ev.target.files?.[0]; if(!file) return;
        const reader = new FileReader(); reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            if(Array.isArray(data.entries)) entries = data.entries;
            if(Array.isArray(data.categories)) categories = data.categories;
            if(data.limits && typeof data.limits==='object') limits = data.limits;
            save(); saveCats(); saveLimits(); refresh(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ');
          }catch(err){ alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON'); }
        }; reader.readAsText(file);
      });

      resetBtn.addEventListener('click', () => {
        if(confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')){ entries = []; save(); refresh(); }
      });

      // Presets in modal
      document.querySelectorAll('.preset').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const cat = btn.getAttribute('data-cat');
          const amt = btn.getAttribute('data-amt');
          catEl.value = cat; amountEl.value = amt;
        });
      });

      // Add entry
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const type = form.elements['type'].value; // income | expense
        const date = dateEl.value || todayISO();
        const category = catEl.value;
        const amount = Number(amountEl.value||0);
        const note = (noteEl.value||'').trim();
        if(!amount || amount<=0) return alert('–£–∫–∞–∂–∏ —Å—É–º–º—É');
        entries.push({ id: crypto.randomUUID(), type, date, category, amount, note });
        save(); modal.close(); refresh();
      });

      // Table interactions
      document.getElementById('table').addEventListener('click', (ev)=>{
        const delBtn = ev.target.closest('[data-del]');
        const head = ev.target.closest('th[data-sort]');
        if(delBtn){ const id = delBtn.getAttribute('data-del'); const rec = entries.find(x=>x.id===id); lastDeleted = rec||null; entries = entries.filter(x=> x.id !== id); save(); refresh(); showUndo(); return; }
        if(head){ const key = head.getAttribute('data-sort'); toggleSort(key); refresh(); }
      });

      undoBtn.addEventListener('click', ()=>{
        if(lastDeleted){ entries.push(lastDeleted); save(); lastDeleted=null; refresh(); hideUndo(); }
      });

      // Filters
      applyFilter.addEventListener('click', ()=>{
        filterState = { cat: filterCategory.value, from: dateFrom.value||'', to: dateTo.value||'' };
        refresh();
      });

      // ===== Renders
      function toggleSort(key){
        if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
        else { sortState.key=key; sortState.dir='asc'; }
        sortInfo.textContent = `${key} ${sortState.dir==='asc'?'‚Üë':'‚Üì'}`;
      }

      function showUndo(){ undoWrap.classList.remove('hidden'); }
      function hideUndo(){ undoWrap.classList.add('hidden'); }

      function renderCharts(monthEntries){
        const byCat = {};
        const byDay = {};
        monthEntries.filter(e=> e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏' && withinFilter(e)).forEach(e=>{
          byCat[e.category] = (byCat[e.category]||0)+e.amount;
          byDay[e.date] = (byDay[e.date]||0)+e.amount;
        });

        const pLabels = Object.keys(byCat);
        const pData = Object.values(byCat);
        if(pie) pie.destroy();
        pie = new Chart(document.getElementById('pieChart'), {
          type: 'doughnut',
          data: { labels: pLabels, datasets: [{ data: pData, backgroundColor: ['#111827','#6366F1','#06B6D4','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#84CC16','#14B8A6'] }] },
          options: { animation:{ duration: 450 }, plugins:{ legend:{ position:'bottom' } }, cutout:'60%' }
        });

        const days = Array.from(new Set(monthEntries.map(e=>e.date))).sort();
        const bLabels = days;
        const bData = days.map(d=> (withinFilter({date:d, category:filterState.cat||''})) ? (byDay[d]||0) : 0);
        if(bar) bar.destroy();
        bar = new Chart(document.getElementById('barChart'), {
          type: 'bar',
          data: { labels: bLabels, datasets: [{ label:'–†–∞—Å—Ö–æ–¥—ã/–¥–µ–Ω—å', data: bData, backgroundColor: '#111827' }] },
          options: { animation:{ duration: 450 }, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ maxRotation:0 } }, y:{ beginAtZero:true } } }
        });
      }

      function renderHeatmap(monthEntries){
        const cal = document.getElementById('calendar'); cal.innerHTML='';
        const [y,m] = monthKey(todayISO()).split('-').map(Number);
        const dim = daysInMonth(y,m);
        const sums = {};
        monthEntries.filter(e=>e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏').forEach(e=>{ const d = Number(e.date.split('-')[2]); sums[d]=(sums[d]||0)+e.amount; });
        const max = Math.max(1, ...Object.values(sums));
        for(let i=1;i<=dim;i++){
          const val = sums[i]||0; const alpha = Math.max(.12, val/max);
          const cell = document.createElement('div');
          cell.className='glass p-2 text-center animate-soft';
          cell.style.background = `rgba(17,24,39,${alpha})`;
          cell.style.color = '#fff';
          cell.innerHTML = `<div class='text-xs opacity-90'>${i}</div><div class='text-[10px] opacity-90'>${val?fmt.format(val):''}</div>`;
          cal.appendChild(cell);
        }
      }

      function renderComparison(curr, prev){
        const box = document.getElementById('compare'); box.innerHTML='';
        const sum = (arr, pred)=> arr.filter(pred).reduce((a,b)=>a+b.amount,0);
        const cIn = sum(curr, e=>e.type==='income');
        const cEx = sum(curr, e=>e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏');
        const pIn = sum(prev, e=>e.type==='income');
        const pEx = sum(prev, e=>e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏');
        const items = [
          ['–î–æ—Ö–æ–¥', cIn, pIn],
          ['–†–∞—Å—Ö–æ–¥', cEx, pEx],
          ['–ë–∞–ª–∞–Ω—Å', cIn-cEx, pIn-pEx]
        ];
        items.forEach((it,i)=>{
          const [name, cur, prv] = it; const diff = cur-prv; const sign = diff>0?'+':'';
          const card = document.createElement('div');
          card.className='glass p-4 animate-card'; card.style.animationDelay=(i*40)+'ms';
          card.innerHTML = `<div class='text-sm text-[color:var(--muted)]'>${name}</div>
            <div class='text-2xl font-semibold'>${fmt.format(cur)}</div>
            <div class='text-sm ${diff>=0?'text-green-600':'text-red-500'}'>${sign}${fmt.format(diff)} –∫ –ø—Ä–æ—à–ª–æ–º—É –º–µ—Å—è—Ü—É</div>`;
          box.appendChild(card);
        });
      }

      function renderCategoryCards(monthEntries){
        const grid = document.getElementById('categoriesGrid'); grid.innerHTML = '';
        const byCat = {};
        monthEntries.filter(e=> e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏' && withinFilter(e)).forEach(e=> byCat[e.category]=(byCat[e.category]||0)+e.amount);
        const totalExp = Object.values(byCat).reduce((a,b)=>a+b,0);
        if(!totalExp){ grid.innerHTML = `<div class='glass p-4 text-center text-[color:var(--muted)] animate-card'>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º</div>`; return; }
        Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([cat,val],i)=>{
          const percent = Math.round(val/totalExp*100);
          const over = limits[cat] && val>Number(limits[cat]);
          const card = document.createElement('div');
          card.className = 'glass p-4 animate-card'; card.style.animationDelay=(i*35)+'ms';
          card.innerHTML = `
            <div class='flex justify-between items-center mb-2'>
              <div class='text-lg font-medium capitalize'>${cat}</div>
              <div class='text-sm text-[color:var(--muted)]'>${percent}%</div>
            </div>
            <div class='flex items-center justify-between mb-2'>
              <div class='text-2xl font-semibold'>${fmt.format(val)}</div>
              <div class='limit-badge ${over?'bg-red-500/10 text-red-600':''}'>–ª–∏–º–∏—Ç: ${limits[cat]?fmt.format(Number(limits[cat])):'‚Äî'}</div>
            </div>
            <div class='w-full bg-white/60 rounded-full h-2 overflow-hidden'>
              <div class='h-2 rounded-full' style='background:var(--bar);width:${percent}%'></div>
            </div>`;
          grid.appendChild(card);
        });
      }

      function buildInsights(monthEntries){
        const box = document.getElementById('insights'); box.innerHTML = '';
        if(monthEntries.length===0){ box.innerHTML = `<div class='glass p-4 animate-card'>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`; return; }
        const income = monthEntries.filter(e=>e.type==='income').reduce((a,b)=>a+b.amount,0);
        const expense = monthEntries.filter(e=>e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏').reduce((a,b)=>a+b.amount,0);
        const byCat = {};
        monthEntries.filter(e=> e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏').forEach(e=> byCat[e.category]=(byCat[e.category]||0)+e.amount);

        const cards = [];
        const pct = income>0 ? (expense/income*100) : 0;
        if(income===0 && expense>0){
          cards.push(['‚ÑπÔ∏è','–î–æ–±–∞–≤—å –¥–æ—Ö–æ–¥—ã','–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã ‚Äî –≤–Ω–µ—Å–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è.']);
        } else if(pct>80){
          cards.push(['üö®','–í—ã—Å–æ–∫–∞—è –¥–æ–ª—è —Ç—Ä–∞—Ç',`–ü–æ—Ç—Ä–∞—á–µ–Ω–æ ${pct.toFixed(0)}% –¥–æ—Ö–æ–¥–∞. –°–¥–µ–ª–∞–π ¬´—ç–∫–æ–Ω–æ–º–Ω—ã–π —É–∏–∫–µ–Ω–¥¬ª ‚Äî –º–∏–Ω—É—Å 300‚Äì800 —Ç—ã—Å. ‚Ç´.`]);
        } else if(pct>0){
          cards.push(['‚úÖ','–¢–µ–º–ø –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π',`–°–µ–π—á–∞—Å –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ ${pct.toFixed(0)}% –¥–æ—Ö–æ–¥–∞.`]);
        }
        // –¢–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å actionable —ç–∫–æ–Ω–æ–º–∏–µ–π
        Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,3).forEach(([cat,sum])=>{
          const weekly = Math.round(sum/4);
          const cut = Math.round(sum*0.25);
          cards.push(['üí°',`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat}`,`${fmt.format(sum)} –∑–∞ –º–µ—Å—è—Ü (~${fmt.format(weekly)}/–Ω–µ–¥). –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 25% –¥–∞—Å—Ç ~${fmt.format(cut)} —ç–∫–æ–Ω–æ–º–∏–∏.`]);
        });
        // –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞ (–ª–∏–Ω–µ–π–Ω–æ)
        const today = new Date();
        const daysGone = today.getDate();
        const [y,m] = monthKey(todayISO()).split('-').map(Number);
        const dim = daysInMonth(y,m);
        const rate = expense / Math.max(1, daysGone);
        const forecast = Math.round(rate * dim);
        cards.push(['üìà','–ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤',`–ï—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—à—å –≤ —Ç–æ–º –∂–µ —Ç–µ–º–ø–µ, —Ç—Ä–∞—Ç—ã –±—É–¥—É—Ç ~${fmt.format(forecast)} –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞.`]);

        cards.forEach((c,i)=>{
          const el = document.createElement('div');
          el.className = 'glass p-4 animate-card'; el.style.animationDelay=(i*40)+'ms';
          el.innerHTML = `<div class='text-2xl'>${c[0]}</div><div class='font-semibold mt-1'>${c[1]}</div><div class='text-sm text-[color:var(--muted)] mt-1'>${c[2]}</div>`;
          box.appendChild(el);
        });
      }

      function renderTable(monthEntries){
        rowsEl.innerHTML = '';
        let data = monthEntries.filter(withinFilter);
        data.sort((a,b)=>{
          const k = sortState.key, dir = sortState.dir==='asc'?1:-1;
          if(k==='amount') return dir*(a.amount-b.amount);
          return dir*String(a[k]).localeCompare(String(b[k]));
        });
        data.forEach((e,i)=>{
          const tr = document.createElement('tr');
          tr.className = 'border-b border-[color:var(--line)] hover:bg-white/40 animate-soft';
          tr.style.animationDelay = (i*18)+'ms';
          tr.innerHTML = `
            <td class='py-2'>${e.date}</td>
            <td class='py-2'><span class='chip'>${e.type==='income'?'–¥–æ—Ö–æ–¥':'—Ä–∞—Å—Ö–æ–¥'}</span></td>
            <td class='py-2'>${e.category}</td>
            <td class='py-2 font-medium'>${fmt.format(e.amount)}</td>
            <td class='py-2'>${(e.note||'')}</td>
            <td class='py-2 text-right'><button class='btn btn-ghost text-sm' data-del='${e.id}'>–£–¥–∞–ª–∏—Ç—å</button></td>`;
          rowsEl.appendChild(tr);
        });
      }

      function buildLimitsUI(){
        const body = document.getElementById('limitsBody'); body.innerHTML='';
        categories.filter(c=>c!=='–¥–æ—Ö–æ–¥').forEach((c,i)=>{
          const wrap = document.createElement('div'); wrap.className='glass p-3 animate-card'; wrap.style.animationDelay=(i*25)+'ms';
          wrap.innerHTML = `
            <div class='text-sm mb-1'>${c}</div>
            <input type='number' min='0' step='10000' class='input w-full' data-limit='${c}' placeholder='–õ–∏–º–∏—Ç (VND)' value='${limits[c]||''}' />`;
          body.appendChild(wrap);
        });
        modalLimits.querySelector('form').onsubmit = (e)=>{
          e.preventDefault();
          body.querySelectorAll('[data-limit]').forEach(inp=>{ const key = inp.getAttribute('data-limit'); const v = Number(inp.value||0); if(v>0) limits[key]=v; else delete limits[key]; });
          saveLimits(); modalLimits.close(); refresh();
        };
      }

      function refresh(){
        monthLabel.textContent = monthKey(todayISO());
        const m = monthKey(todayISO());
        const pm = (()=>{ const d=new Date(todayISO()); let y=d.getFullYear(), mo=d.getMonth(); if(mo===0){y--;mo=12;} return `${y}-${String(mo).padStart(2,'0')}`; })();
        const monthEntries = entries.filter(e=> monthKey(e.date)===m);
        const prevEntries = entries.filter(e=> monthKey(e.date)===pm);

        const income = monthEntries.filter(e=>e.type==='income').reduce((a,b)=>a+b.amount,0);
        const expense = monthEntries.filter(e=>e.type==='expense' && e.category!=='–¥–æ–ª–≥–∏').reduce((a,b)=>a+b.amount,0);
        incomeSum.textContent = income? fmt.format(income) : '‚Äî';
        expenseSum.textContent = expense? fmt.format(expense) : '‚Äî';
        balanceEl.textContent = fmt.format(income-expense);
        const pct = income>0 ? Math.min(100, Math.round(expense/income*100)) : 0;
        spentPct.textContent = income>0? pct+'%':'‚Äî';
        progressBar.style.width = pct+'%';

        populateFilterCats();
        renderCharts(monthEntries);
        renderHeatmap(monthEntries);
        renderComparison(monthEntries, prevEntries);
        renderCategoryCards(monthEntries);
        buildInsights(monthEntries);
        renderTable(monthEntries);
        hideUndo();
      }

      // Init
      populateCats();
      dateEl.value = todayISO();
      refresh();
    });
  </script>
</body>
</html>
