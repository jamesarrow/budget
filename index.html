<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MY BUDGET — Vision Ultra v2.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#f7f9ff;--bg2:#ffffff;--text:#111827;--muted:#6b7280;--glass:rgba(255,255,255,.6);--glass-brd:rgba(17,24,39,.06);--ring:rgba(17,24,39,.12)}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh}
    .glass{backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);background:var(--glass);border:1px solid var(--glass-brd);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .hover-card{transition:all .25s cubic-bezier(.4,0,.2,1)}
    .hover-card:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 12px 28px rgba(0,0,0,.08)}
    .btn{display:flex;align-items:center;justify-content:flex-start;padding:.55rem .9rem;border-radius:10px;font-weight:500;font-size:.85rem;border:1px solid var(--glass-brd);background:rgba(255,255,255,.7);color:var(--text);transition:all .25s cubic-bezier(.4,0,.2,1)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .btn-black{background:#111827;color:#fff;border:none}
    .btn-black:hover{filter:brightness(1.05)}
    .btn-danger{background:#ef4444;color:#fff;border:none}
    .nav-item{display:flex;align-items:center;gap:.55rem;padding:.6rem .8rem;border-radius:10px;transition:all .2s}
    .nav-item:hover{background:rgba(17,24,39,.06);box-shadow:inset 0 0 0 1px rgba(17,24,39,.06)}
    .nav-item svg{width:20px;height:20px;color:#475569}
    .chip{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:#111827;color:#fff;font-size:.72rem;font-weight:600}
    .cat-pill{border:1px solid var(--glass-brd);border-radius:10px;padding:.5rem .9rem;font-size:.85rem;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1)}
    .cat-pill:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .cat-pill.active{background:#111827;color:#fff;box-shadow:0 0 0 3px rgba(17,24,39,.15),0 0 12px rgba(17,24,39,.25)}
    dialog{border:none;border-radius:18px;padding:0;max-height:85vh;overflow:hidden}
    dialog form{overflow-y:auto;max-height:85vh}
    dialog::backdrop{background:rgba(0,0,0,.35);backdrop-filter:blur(6px)}
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="grid grid-cols-12 gap-6">
      <!-- Sidebar -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <div class="glass p-4">
          <div class="text-sm text-[color:var(--muted)] mb-1">Dashboard</div>
          <div class="text-2xl font-semibold tracking-wider mb-4">MY BUDGET</div>
          <div class="space-y-2 mb-3">
            <button id="addIncomeBtn" class="btn btn-black w-full">Добавить доход</button>
            <button id="addExpenseBtn" class="btn btn-black w-full">Добавить расход</button>
          </div>
          <nav class="space-y-1">
            <button id="addCategoryBtn" class="nav-item w-full" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18M3 12h18M3 17h18"/></svg>
              <span>Категории</span>
            </button>
            <button id="limitsBtn" class="nav-item w-full" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
              <span>Лимиты</span>
            </button>
            <button id="exportBtn" class="nav-item w-full" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8"/><path d="M9 7h1"/><path d="M9 11h1"/><path d="M9 15h1"/><path d="M21 15v6"/><path d="M17 19h8"/></svg>
              <span>Экспорт CSV</span>
            </button>
            <button id="resetBtn" class="nav-item w-full" type="button" style="color:#b91c1c">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-2 14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
              <span>Очистить</span>
            </button>
          </nav>
          <div class="mt-6 text-xs text-[color:var(--muted)]">Данные сохраняются только на этом устройстве (localStorage).</div>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-span-12 md:col-span-9 lg:col-span-10 space-y-6">
        <!-- Summary -->
        <section class="grid sm:grid-cols-3 gap-4">
          <div class="glass p-5 hover-card"><div class="text-sm text-[color:var(--muted)]">Получено</div><div id="incomeSum" class="text-3xl font-semibold mt-1">—</div></div>
          <div class="glass p-5 hover-card"><div class="text-sm text-[color:var(--muted)]">Потрачено</div><div id="expenseSum" class="text-3xl font-semibold mt-1">—</div></div>
          <div class="glass p-5 hover-card"><div class="text-sm text-[color:var(--muted)]">Баланс месяца</div><div id="balance" class="text-3xl font-semibold mt-1">—</div><div class="mt-3 w-full bg-white/60 rounded-full h-2 overflow-hidden"><div id="progressBar" class="h-2 rounded-full" style="background:#111827;width:0%"></div></div></div>
        </section>

        <!-- Charts + Heatmap -->
        <section class="grid lg:grid-cols-3 gap-4">
          <div class="glass p-5 hover-card lg:col-span-2">
            <div class="flex items-center justify-between mb-2"><h2 class="font-semibold">Расходы по категориям</h2><div class="text-sm text-[color:var(--muted)]">Месяц: <span id="monthLabel"></span></div></div>
            <canvas id="pieChart" height="160"></canvas>
          </div>
          <div class="glass p-5 hover-card"><h2 class="font-semibold mb-2">Динамика по дням</h2><canvas id="barChart" height="160"></canvas></div>
        </section>

        <section class="grid lg:grid-cols-3 gap-4">
          <div class="glass p-5 hover-card lg:col-span-1"><h2 class="font-semibold mb-2">Календарь расходов</h2><div id="calendar" class="grid grid-cols-7 gap-1 text-sm"></div></div>
          <div class="glass p-5 hover-card lg:col-span-2"><h2 class="font-semibold mb-2">Инсайты</h2><div id="insights" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div></div>
        </section>

        <!-- Category cards -->
        <section class="space-y-3">
          <h2 class="text-xl font-semibold">Расходы по категориям</h2>
          <div id="categoriesGrid" class="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </section>

        <!-- Table -->
        <section class="glass p-5 hover-card">
          <div class="flex items-center justify-between mb-2"><h2 class="font-semibold">Записи текущего месяца</h2><div class="text-sm text-[color:var(--muted)]">Сортировка: <span id="sortInfo">дата ↑</span></div></div>
          <div class="overflow-x-auto"><table class="min-w-full text-sm" id="table"><thead><tr class="text-left text-[color:var(--muted)] border-b"><th class="py-2 cursor-pointer" data-sort="date">Дата</th><th class="py-2 cursor-pointer" data-sort="type">Тип</th><th class="py-2 cursor-pointer" data-sort="category">Категория</th><th class="py-2 cursor-pointer" data-sort="amount">Сумма</th><th class="py-2">Примечание</th><th class="py-2 text-right">Действия</th></tr></thead><tbody id="rows"></tbody></table></div>
          <div id="undoWrap" class="mt-3 hidden"><button id="undoBtn" class="btn">Отменить удаление</button></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <dialog id="modal">
    <form id="form" method="dialog" class="glass p-6 w-[92vw] max-w-lg">
      <div class="flex items-center justify-between mb-3"><h3 class="text-xl font-semibold" id="modalTitle">Добавить запись</h3><button type="button" id="closeModal" class="btn">Закрыть</button></div>
      <div class="grid gap-4">
        <input id="date" type="date" class="input border border-[color:var(--glass-brd)] rounded-lg p-2" />
        <div>
          <div class="text-sm text-[color:var(--muted)] mb-2">Категория (нажми, чтобы выбрать)</div>
          <div id="categoryCardsPicker" class="flex gap-2 flex-wrap"></div>
          <button id="addCategoryInModal" type="button" class="btn mt-2">+ Новая категория</button>
        </div>
        <input id="amount" type="number" min="0" step="1000" placeholder="Сумма (VND)" class="input border border-[color:var(--glass-brd)] rounded-lg p-2" />
        <input id="note" type="text" placeholder="Примечание" class="input border border-[color:var(--glass-brd)] rounded-lg p-2" />
      </div>
      <div class="flex justify-end gap-3 mt-5"><button class="btn btn-black" id="saveBtn">Сохранить</button></div>
    </form>
  </dialog>

  <dialog id="modalCategory">
    <form method="dialog" class="glass p-6 w-[92vw] max-w-md">
      <h3 class="text-xl font-semibold mb-4">Категории</h3>
      <div class="flex gap-2 mb-3"><input id="newCategoryName" class="input border border-[color:var(--glass-brd)] rounded-lg p-2 flex-1" placeholder="Новая категория"/><button id="saveCatBtn" class="btn">Добавить</button></div>
      <div class="text-sm text-[color:var(--muted)] mb-2">Текущие:</div>
      <div id="catList" class="flex flex-wrap gap-2"></div>
      <div class="flex justify-end mt-5"><button id="closeCatModal" class="btn" value="cancel">Закрыть</button></div>
    </form>
  </dialog>

  <dialog id="modalLimits">
    <form method="dialog" class="glass p-6 w-[92vw] max-w-lg">
      <div class="flex items-center justify-between mb-3"><h3 class="text-xl font-semibold">Лимиты по категориям</h3><button type="button" id="closeLimits" class="btn">Закрыть</button></div>
      <div id="limitsBody" class="grid sm:grid-cols-2 gap-3"></div>
      <div class="flex justify-end gap-3 mt-5"><button class="btn btn-black">Сохранить</button></div>
    </form>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utils
      const fmt = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'VND', maximumFractionDigits:0 });
      const monthKey = (iso) => iso.slice(0,7);
      const todayISO = () => new Date().toISOString().slice(0,10);
      const daysInMonth = (y,m)=> new Date(y,m,0).getDate();

      // ===== Storage
      const STORAGE_KEY = 'mybudget_entries_v7';
      const CAT_KEY = 'mybudget_categories_v7';
      const LIM_KEY = 'mybudget_limits_v3';
      let entries = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      let categories = JSON.parse(localStorage.getItem(CAT_KEY)||'[]');
      let limits = JSON.parse(localStorage.getItem(LIM_KEY)||'{}');
      if(categories.length===0) categories = ['еда','кофе','алкоголь','одежда','транспорт','коммуналка','развлечения','жильё','долги','прочее'];

      // ===== Elements
      const addIncomeBtn = document.getElementById('addIncomeBtn');
      const addExpenseBtn = document.getElementById('addExpenseBtn');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      const limitsBtn = document.getElementById('limitsBtn');
      const exportBtn = document.getElementById('exportBtn');
      const resetBtn = document.getElementById('resetBtn');

      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const dateEl = document.getElementById('date');
      const amountEl = document.getElementById('amount');
      const noteEl = document.getElementById('note');
      const categoryCardsPicker = document.getElementById('categoryCardsPicker');
      const addCategoryInModal = document.getElementById('addCategoryInModal');

      const modalCategory = document.getElementById('modalCategory');
      const newCategoryName = document.getElementById('newCategoryName');
      const saveCatBtn = document.getElementById('saveCatBtn');
      const catList = document.getElementById('catList');

      const modalLimits = document.getElementById('modalLimits');
      const limitsBody = document.getElementById('limitsBody');

      const incomeSum = document.getElementById('incomeSum');
      const expenseSum = document.getElementById('expenseSum');
      const balanceEl = document.getElementById('balance');
      const progressBar = document.getElementById('progressBar');
      const monthLabel = document.getElementById('monthLabel');

      const rowsEl = document.getElementById('rows');
      const sortInfo = document.getElementById('sortInfo');
      const undoWrap = document.getElementById('undoWrap');
      const undoBtn = document.getElementById('undoBtn');

      let lastDeleted=null; let sortState={key:'date',dir:'asc'}; let selectedCategory=''; let currentType='income';
      let pie,bar;

      // ===== Helpers
      const save=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(entries));
      const saveCats=()=>localStorage.setItem(CAT_KEY,JSON.stringify(categories));
      const saveLimits=()=>localStorage.setItem(LIM_KEY,JSON.stringify(limits));

      function renderCategoryPicker(){
        categoryCardsPicker.innerHTML='';
        const list = (currentType==='income')? ['доход'] : categories.filter(c=>c!=='доход');
        list.forEach((c,i)=>{ const pill=document.createElement('div'); pill.className='cat-pill'; pill.style.animationDelay=(i*25)+'ms'; pill.textContent=c; if(c===selectedCategory) pill.classList.add('active'); pill.onclick=()=>{selectedCategory=c; renderCategoryPicker();}; categoryCardsPicker.appendChild(pill); });
      }

      function openModal(type){
        currentType = type; modalTitle.textContent = type==='income'?'Добавить доход':'Добавить расход';
        dateEl.value = todayISO(); selectedCategory = (type==='income')?'доход':(categories[0]||'прочее');
        renderCategoryPicker(); modal.showModal();
      }

      document.getElementById('closeModal').onclick=()=>modal.close();
      addIncomeBtn.onclick=()=>openModal('income');
      addExpenseBtn.onclick=()=>openModal('expense');

      addCategoryInModal.onclick=()=>{ const name=prompt('Название новой категории'); if(!name) return; if(!categories.includes(name.trim())){ categories.push(name.trim()); saveCats(); selectedCategory=name.trim(); renderCategoryPicker(); }}

      // Category manager
      addCategoryBtn.onclick=()=>{ renderCatManager(); modalCategory.showModal(); };
      document.getElementById('closeCatModal').onclick=()=>modalCategory.close();
      saveCatBtn.onclick=(e)=>{ e.preventDefault(); const name=(newCategoryName.value||'').trim(); if(!name) return; if(categories.includes(name)) return alert('Такая категория уже есть'); categories.push(name); saveCats(); newCategoryName.value=''; renderCatManager(); alert('Категория добавлена'); };
      function renderCatManager(){ catList.innerHTML=''; categories.forEach(c=>{ const pill=document.createElement('div'); pill.className='cat-pill'; pill.textContent=c; catList.appendChild(pill); }); }

      // Limits
      limitsBtn.onclick=()=>{ buildLimitsUI(); modalLimits.showModal(); };
      document.getElementById('closeLimits').onclick=()=>modalLimits.close();
      function buildLimitsUI(){ limitsBody.innerHTML=''; categories.filter(c=>c!=='доход').forEach((c,i)=>{ const wrap=document.createElement('div'); wrap.className='glass p-3'; wrap.innerHTML=`<div class='text-sm mb-1'>${c}</div><input type='number' min='0' step='10000' class='input border border-[color:var(--glass-brd)] rounded-lg p-2 w-full' data-limit='${c}' placeholder='Лимит (VND)' value='${limits[c]||''}'/>`; limitsBody.appendChild(wrap); }); modalLimits.querySelector('form').onsubmit=(e)=>{ e.preventDefault(); limitsBody.querySelectorAll('[data-limit]').forEach(inp=>{ const key=inp.getAttribute('data-limit'); const v=Number(inp.value||0); if(v>0) limits[key]=v; else delete limits[key]; }); saveLimits(); modalLimits.close(); refresh(); } }

      // Save entry
      document.getElementById('saveBtn').onclick=(e)=>{ e.preventDefault(); const amount=Number(amountEl.value||0); if(!amount) return alert('Введите сумму'); const date=dateEl.value||todayISO(); const note=(noteEl.value||''); const cat = (currentType==='income')?'доход':(selectedCategory||'прочее'); entries.push({id:crypto.randomUUID(), type:currentType, date, category:cat, amount, note}); save(); modal.close(); refresh(); };

      // Export & reset
      exportBtn.onclick=()=>{ const header=['id','type','date','category','amount','note']; const csv=[header.join(',')].concat(entries.map(e=> header.map(k=>""+String(e[k]??'').replaceAll('"','""')).map(v=>`"${v}`+`"`).join(','))).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`mybudget_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url); };
      resetBtn.onclick=()=>{ if(confirm('Точно удалить все данные?')){ entries=[]; save(); refresh(); }};

      // Table interactions
      document.getElementById('table').addEventListener('click',(ev)=>{ const delBtn=ev.target.closest('[data-del]'); const head=ev.target.closest('th[data-sort]'); if(delBtn){ const id=delBtn.getAttribute('data-del'); const rec=entries.find(x=>x.id===id); lastDeleted=rec||null; entries=entries.filter(x=>x.id!==id); save(); refresh(); undoWrap.classList.remove('hidden'); } if(head){ const key=head.getAttribute('data-sort'); if(sortState.key===key){ sortState.dir=(sortState.dir==='asc'?'desc':'asc'); }else{ sortState.key=key; sortState.dir='asc'; } sortInfo.textContent=`${key} ${sortState.dir==='asc'?'↑':'↓'}`; refresh(); }});
      undoBtn.onclick=()=>{ if(lastDeleted){ entries.push(lastDeleted); save(); lastDeleted=null; refresh(); undoWrap.classList.add('hidden'); }};

      // Charts
      let pieChart, barChart;
      function renderCharts(monthEntries){ const byCat={}, byDay={}; monthEntries.filter(e=>e.type==='expense'&&e.category!=='долги').forEach(e=>{byCat[e.category]=(byCat[e.category]||0)+e.amount; byDay[e.date]=(byDay[e.date]||0)+e.amount;}); const pLabels=Object.keys(byCat), pData=Object.values(byCat); if(pieChart) pieChart.destroy(); pieChart=new Chart(document.getElementById('pieChart'),{type:'doughnut',data:{labels:pLabels,datasets:[{data:pData,backgroundColor:['#111827','#6366F1','#06B6D4','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#84CC16','#14B8A6']}]},options:{animation:{duration:500},plugins:{legend:{position:'bottom'}},cutout:'60%'}}); const days=Array.from(new Set(monthEntries.map(e=>e.date))).sort(); if(barChart) barChart.destroy(); barChart=new Chart(document.getElementById('barChart'),{type:'bar',data:{labels:days,datasets:[{data:days.map(d=>byDay[d]||0),backgroundColor:'#111827'}]},options:{animation:{duration:500},plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:0}},y:{beginAtZero:true}}}}); }

      // Heatmap
      function renderHeatmap(monthEntries){ const cal=document.getElementById('calendar'); cal.innerHTML=''; const [y,m]=monthKey(todayISO()).split('-').map(Number); const dim=daysInMonth(y,m); const sums={}; monthEntries.filter(e=>e.type==='expense'&&e.category!=='долги').forEach(e=>{const d=Number(e.date.split('-')[2]); sums[d]=(sums[d]||0)+e.amount;}); const max=Math.max(1,...Object.values(sums)); for(let i=1;i<=dim;i++){ const val=sums[i]||0; const alpha=Math.max(.1,val/max); const cell=document.createElement('div'); cell.className='glass p-2 text-center hover-card'; cell.style.background=`rgba(17,24,39,${alpha})`; cell.style.color='#fff'; cell.innerHTML=`<div class='text-xs opacity-90'>${i}</div><div class='text-[10px] opacity-90'>${val?fmt.format(val):''}</div>`; cal.appendChild(cell);} }

      // Category cards + insights + table
      function renderCategoryCards(monthEntries){ const grid=document.getElementById('categoriesGrid'); grid.innerHTML=''; const byCat={}; monthEntries.filter(e=>e.type==='expense'&&e.category!=='долги').forEach(e=>byCat[e.category]=(byCat[e.category]||0)+e.amount); const totalExp=Object.values(byCat).reduce((a,b)=>a+b,0); if(!totalExp){ grid.innerHTML=`<div class='glass p-4 text-center text-[color:var(--muted)]'>Пока нет данных по расходам</div>`; return; } Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([cat,val],i)=>{ const percent=Math.round(val/totalExp*100); const over=limits[cat]&&val>Number(limits[cat]); const card=document.createElement('div'); card.className='glass p-4 hover-card'; card.style.animationDelay=(i*35)+'ms'; card.innerHTML=`<div class='flex justify-between items-center mb-2'><div class='text-lg font-medium'>${cat}</div><div class='text-sm text-[color:var(--muted)]'>${percent}%</div></div><div class='flex items-center justify-between mb-2'><div class='text-2xl font-semibold'>${fmt.format(val)}</div><div class='text-xs border rounded px-2 py-1 ${over?'bg-red-500/10 text-red-600 border-red-300/40':'border-[color:var(--glass-brd)]'}'>лимит: ${limits[cat]?fmt.format(Number(limits[cat])):'—'}</div></div><div class='w-full bg-white/60 rounded-full h-2 overflow-hidden'><div class='h-2 rounded-full' style='background:#111827;width:${percent}%'></div></div>`; grid.appendChild(card); }); }

      function buildInsights(monthEntries){ const box=document.getElementById('insights'); box.innerHTML=''; if(monthEntries.length===0){ box.innerHTML=`<div class='glass p-4 hover-card'>Пока нет данных</div>`; return;} const income=monthEntries.filter(e=>e.type==='income').reduce((a,b)=>a+b.amount,0); const expense=monthEntries.filter(e=>e.type==='expense'&&e.category!=='долги').reduce((a,b)=>a+b.amount,0); const byCat={}; monthEntries.filter(e=>e.type==='expense'&&e.category!=='долги').forEach(e=>byCat[e.category]=(byCat[e.category]||0)+e.amount); const top=Object.entries(byCat).sort((a,b)=>b[1]-a[1])[0]; const cards=[]; const pct=income>0?(expense/income*100):0; if(income===0&&expense>0){ cards.push(['Добавь доходы','Чтобы увидеть баланс и проценты — внеси поступления.']); } else { cards.push(['Темп месяца',`Сейчас израсходовано ${pct.toFixed(0)}% дохода.`]); } if(top){ const [tCat,tSum]=top; const cut=Math.round(tSum*0.25); cards.push([`Основная категория: ${tCat}`,`${fmt.format(tSum)} за месяц. Снижение на 25% даст ~${fmt.format(cut)} экономии.`]); } const today=new Date(); const daysGone=today.getDate(); const [y,m]=monthKey(todayISO()).split('-').map(Number); const dim=daysInMonth(y,m); const forecast=Math.round((expense/Math.max(1,daysGone))*dim); cards.push(['Прогноз',`Если продолжишь в том же темпе, расходы будут около ${fmt.format(forecast)} к концу месяца.`]); cards.forEach((c,i)=>{ const el=document.createElement('div'); el.className='glass p-4 hover-card'; el.style.animationDelay=(i*40)+'ms'; el.innerHTML=`<div class='font-semibold mb-1'>${c[0]}</div><div class='text-sm text-[color:var(--muted)]'>${c[1]}</div>`; box.appendChild(el); }); }

      function renderTable(monthEntries){ rowsEl.innerHTML=''; let data=monthEntries.slice(); data.sort((a,b)=>{ const k=sortState.key, dir=sortState.dir==='asc'?1:-1; if(k==='amount') return dir*(a.amount-b.amount); return dir*String(a[k]).localeCompare(String(b[k])); }); data.forEach((e,i)=>{ const tr=document.createElement('tr'); tr.className='border-b border-[rgba(17,24,39,.08)] hover:bg-white/50'; tr.style.animationDelay=(i*18)+'ms'; tr.innerHTML=`<td class='py-2'>${e.date}</td><td class='py-2'><span class='chip'>${e.type==='income'?'доход':'расход'}</span></td><td class='py-2'>${e.category}</td><td class='py-2 font-medium'>${fmt.format(e.amount)}</td><td class='py-2'>${e.note||''}</td><td class='py-2 text-right'><button class='btn' data-del='${e.id}'>Удалить</button></td>`; rowsEl.appendChild(tr); }); }

      // Refresh
      function refresh(){ monthLabel.textContent=monthKey(todayISO()); const m=monthKey(todayISO()); const monthEntries=entries.filter(e=>monthKey(e.date)===m); const income=monthEntries.filter(e=>e.type==='income').reduce((a,b)=>a+b.amount,0); const expense=monthEntries.filter(e=>e.type==='expense'&&e.category!=='долги').reduce((a,b)=>a+b.amount,0); incomeSum.textContent=income?fmt.format(income):'—'; expenseSum.textContent=expense?fmt.format(expense):'—'; balanceEl.textContent=fmt.format(income-expense); const pct=income>0?Math.min(100,Math.round(expense/income*100)):0; progressBar.style.width=pct+'%'; renderCharts(monthEntries); renderHeatmap(monthEntries); renderCategoryCards(monthEntries); buildInsights(monthEntries); renderTable(monthEntries); undoWrap.classList.add('hidden'); }

      // Init
      dateEl.value=todayISO(); refresh();
    });
  </script>
</body>
</html>
